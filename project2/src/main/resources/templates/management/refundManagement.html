<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
	  xmlns:sec="http://www.thymeleaf.org/thymeleaf-extras-springsecurity6">
<head>
	<meta charset="UTF-8">
    <meta name="_csrf" th:content="${_csrf.token}"/>
    <meta name="_csrf_header" th:content="${_csrf.headerName}"/>
	<title>환불 관리 대시보드</title>
	<!-- Bootstrap CSS -->
	<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
	<!-- Font Awesome for Icons -->
	<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
    
    <style>
		.status-badge {
			font-size: 0.8em;
			padding: 0.3em 0.6em;
		}
		.status-REFUND_PENDING { background-color: #ffc107; }
		.status-REFUND_APPROVED { background-color: #28a745; }
		.status-REFUND_REJECTED { background-color: #dc3545; }
		.status-REFUND_REQUESTED { background-color: #17a2b8; }
        
		.action-buttons {
			display: flex;
			gap: 0.5rem;
		}
		.filter-section {
			background-color: #f8f9fa;
			padding: 1rem;
			margin-bottom: 1rem;
			border-radius: 0.5rem;
		}		
	</style>
</head>
<body>
	<div class="container-fluid">
		<div class="row">
			<!-- Sidebar Navigation -->
			<nav class="col-md-2 d-md-block bg-light sidebar">
				<div class="position-sticky">
					<ul class="nav flex-column">
						<li class="nav-item">
							<a class="nav-link" href="/manager/orders">
								<i class="fas fa-shopping-cart"></i> 주문 관리
							</a>
						</li>
						<li class="nav-item">
							<a class="nav-link active" href="#">
								<i class="fas fa-undo"></i> 환불 관리
							</a>
						</li>
			            <li class="nav-item">
			                <a class="nav-link" href="/stocks">
			                    <i class="fas fa-boxes"></i> 재고 관리
			                </a>
			            </li>
						<hr class="my-3">
			            <li class="nav-item">
			                <a class="nav-link" href="javascript:goAttendance()">
			                  <i class="fa-regular fa-calendar-days"></i> 직원 메뉴
			                </a>
			            </li>
			            <li class="nav-item">
			                <a class="nav-link" href="/shop/list">
			                    <i class="fas fa-shopping-bag"></i> 쇼핑몰 바로가기
			                </a>
			            </li>
					</ul>
				</div>
			</nav>

            <!-- Main Content -->
            <main class="col-md-10 ms-sm-auto px-4">
                <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                    <h1 class="h2">환불 관리 대시보드</h1>
                </div>

                <!-- Filters -->
                <div class="filter-section">
                    <div class="row">
                        <div class="col-md-3">
                            <select class="form-select" id="statusFilter">
                                <option value="">전체 상태</option>
                                <option value="REFUND_PENDING">환불 대기</option>
                                <option value="REFUND_APPROVED">환불 승인</option>
                                <option value="REFUND_REJECTED">환불 거절</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <input type="date" class="form-control" id="startDateFilter">
                        </div>
                        <div class="col-md-3">
                            <input type="date" class="form-control" id="endDateFilter">
                        </div>
                        <div class="col-md-3">
                            <input type="text" class="form-control" placeholder="고객명 검색" id="searchInput">
                        </div>
                    </div>
                </div>

                <!-- Refund List -->
                <div class="table-responsive">
                    <table class="table table-striped table-hover">
                        <thead class="table-dark">
                            <tr>
								<th>주문 번호</th>
								<th>고객명</th>
								<th>주문 날짜</th>
								<th>환불 금액</th>
								<th>상태</th>
								<th>액션</th>
                            </tr>
                        </thead>
                        <tbody id="refundTableBody">
							<tr th:each="refund : ${refundList.content}">
							    <td th:text="${refund.orderId}">주문 번호</td>
							    <td th:text="${refund.customerName}">고객명</td>
							    <td th:text="${#temporals.format(refund.orderDate, 'yyyy-MM-dd HH:mm')}">주문 날짜</td>
							    <td th:text="${#numbers.formatInteger(refund.totalAmount, 0, 'COMMA') + '원'}">환불 금액</td>
							    <td>
							        <span th:class="|badge status-badge status-${refund.orderStatus}|"
							              th:text="${refund.orderStatus}">상태</span>
							    </td>
							    <td>
							        <div class="action-buttons">
							            <button class="btn btn-sm btn-success"
							                    th:data-order-id="${refund.orderId}"
							                    data-bs-toggle="modal"
							                    data-bs-target="#refundDetailsModal">
							                <i class="fas fa-eye"></i> 상세
							            </button>
							        </div>
							    </td>
							</tr>
                            <!-- More rows will be dynamically added -->
                        </tbody>
                    </table>
                </div>

                <!-- Pagination -->
                <nav aria-label="Page navigation">
                    <ul class="pagination justify-content-center">
						<li class="page-item" th:classappend="${!refundList.hasPrevious} ? disabled">
							<a class="page-link" th:href="@{/manager/refunds(page=${refundList.number - 1})}">이전</a>
                        </li>
                        <li class="page-item" th:each="pageNum : ${#numbers.sequence(0, refundList.totalPages - 1)}"
                        	th:classappend="${pageNum == refundList.number} ? 'active'">
							<a class="page-link" th:href="@{/manager/refunds(page=${pageNum})}"
								th:text="${pageNum + 1}">1</a>
                        </li>
						<li class="page-item" th:classappend="${!refundList.hasNext} ? disabled">
							<a class="page-link" th:href="@{/manager/refunds(page=${refundList.number + 1})}">다음</a>
						</li>
                    </ul>
                </nav>
            </main>
        </div>
    </div>

    <!-- Refund Details Modal -->
    <div class="modal fade" id="refundDetailsModal" tabindex="-1" aria-labelledby="refundDetailsModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="refundDetailsModalLabel">환불 상세 정보</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h6>주문자 정보</h6>
                            <p><strong>이름:</strong> <span id="customerName"></span></p>
                            <p><strong>연락처:</strong> <span id="customerPhone"></span></p>
                            <p><strong>이메일:</strong> <span id="customerEmail"></span></p>
                        </div>
                        <div class="col-md-6">
                            <h6>환불 정보</h6>
                            <p><strong>환불 사유:</strong> <span id="refundReason"></span></p>
                            <p><strong>환불 방법:</strong> <span id="refundMethod"></span></p>
                            <p><strong>환불 요청 날짜:</strong> <span id="refundRequestDate"></span></p>
                        </div>
                    </div>

                    <h6 class="mt-3">주문 상품 목록</h6>
                    <table class="table">
                        <thead>
                            <tr>
                                <th>상품명</th>
                                <th>수량</th>
                                <th>가격</th>
                                <th>소계</th>
                            </tr>
                        </thead>
						<tbody id="refundProductsBody">
                        </tbody>
                        <tfoot>
                            <tr>
                                <td colspan="3" class="text-end"><strong>총 환불 금액</strong></td>
                                <td><strong id="totalRefundAmount"></strong></td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">닫기</button>
                    <button type="button" class="btn btn-success refund-approve-btn">환불 승인</button>
                    <button type="button" class="btn btn-danger refund-reject-btn">환불 거절</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS and Popper.js -->
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.6/dist/umd/popper.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.min.js"></script>
    
	<script>
	document.addEventListener('DOMContentLoaded', function() {
	    // DOM 요소 참조
	    const statusFilter = document.getElementById('statusFilter');
	    const startDateFilter = document.getElementById('startDateFilter');
	    const endDateFilter = document.getElementById('endDateFilter');
	    const searchInput = document.getElementById('searchInput');
	    const modalApproveBtn = document.querySelector('#refundDetailsModal .refund-approve-btn');
	    const modalRejectBtn = document.querySelector('#refundDetailsModal .refund-reject-btn');

	    // 상태 텍스트 매핑
	    const statusText = {
	        'REFUND_PENDING': '환불 대기',
	        'REFUND_APPROVED': '환불 승인',
	        'REFUND_REJECTED': '환불 거절',
	        'REFUND_REQUESTED': '환불 요청'
	    };

	    // 환불 상태 업데이트 함수
	    function updateRefundStatus(orderId, approve, managerComment = '') {
	        const token = document.querySelector('meta[name="_csrf"]').getAttribute('content');
	        const header = document.querySelector('meta[name="_csrf_header"]').getAttribute('content');
	        
	        fetch(`/api/manager/orders/refunds/${orderId}/process`, {
	            method: 'POST',
	            headers: {
	                'Content-Type': 'application/json',
	                [header]: token
	            },
	            body: JSON.stringify({
	                approve: approve,
	                managerComment: managerComment
	            })
	        })
	        .then(response => response.json())
	        .then(data => {
	            alert(approve ? '환불이 승인되었습니다.' : '환불이 거절되었습니다.');
	            bootstrap.Modal.getInstance(document.getElementById('refundDetailsModal')).hide();
	            applyFilters();
	        })
	        .catch(error => {
	            console.error('Error:', error);
	            alert('환불 처리 중 오류가 발생했습니다.');
	        });
	    }

	    // 모달 승인/거절 버튼 이벤트 리스너
	    modalApproveBtn.addEventListener('click', function() {
	        const orderId = this.dataset.orderId;
	        if(confirm('환불을 승인하시겠습니까?')) {
	            updateRefundStatus(orderId, true);
	        }
	    });

	    modalRejectBtn.addEventListener('click', function() {
	        const orderId = this.dataset.orderId;
	        const comment = prompt('환불 거절 사유를 입력해주세요:');
	        if(comment !== null && comment.trim() !== '') {
	            updateRefundStatus(orderId, false, comment);
	        }
	    });

	    // 필터 이벤트 리스너
	    statusFilter.addEventListener('change', applyFilters);
	    startDateFilter.addEventListener('change', applyFilters);
	    endDateFilter.addEventListener('change', applyFilters);
	    
	    // 검색어 입력 디바운싱
	    let searchTimeout;
	    searchInput.addEventListener('input', function() {
	        clearTimeout(searchTimeout);
	        searchTimeout = setTimeout(applyFilters, 300);
	    });

	    // 필터 적용 함수
	    function applyFilters() {
	        console.log('Status:', statusFilter.value);
	        console.log('Start Date:', startDateFilter.value);
	        console.log('End Date:', endDateFilter.value);
	        console.log('Search:', searchInput.value.trim());
	    	
	        const params = new URLSearchParams();
	        params.append('status', statusFilter.value || 'REFUND_REQUESTED');
	        
	        if (startDateFilter.value) {
	            params.append('startDate', startDateFilter.value + 'T00:00:00');
	        }
	        if (endDateFilter.value) {
	            params.append('endDate', endDateFilter.value + 'T23:59:59');
	        }
	        if (searchInput.value.trim()) {
	            params.append('search', searchInput.value.trim());
	        }
	        
	        console.log('Params:', params.toString());

	        const token = document.querySelector('meta[name="_csrf"]').getAttribute('content');
	        const header = document.querySelector('meta[name="_csrf_header"]').getAttribute('content');

	        fetch(`/api/refunds/management?${params.toString()}`, {
	            method: 'GET',
	            headers: { [header]: token }
	        })
	        .then(response => {
	            console.log('Response status:', response.status);
				return response.json()
			})
	        .then(data => {
	            console.log('Received data:', data);
	        	updateTable(data);
	        })
	        .catch(error => {
	            console.error('Full error:', error);
	            handleError(error);
	        });
	    }
	    
	    document.addEventListener('DOMContentLoaded', function() {
	        statusFilter.value = 'REFUND_REQUESTED';
	        applyFilters();
	    });

	    // 테이블 업데이트 함수
	    function updateTable(data) {
	        const refundTableBody = document.getElementById('refundTableBody');
	        refundTableBody.innerHTML = '';

	        if (!data.content || data.content.length === 0) {
	            refundTableBody.innerHTML = `
	                <tr><td colspan="6" class="text-center">검색 결과가 없습니다.</td></tr>
	            `;
	            return;
	        }

	        data.content.forEach(refund => {
	            const row = createTableRow(refund);
	            refundTableBody.appendChild(row);
	        });
	    }

	    // 테이블 행 생성 함수
	    function createTableRow(refund) {
	        const row = document.createElement('tr');
	        row.innerHTML = `
	            <td>${refund.orderId}</td>
	            <td>${refund.customerName}</td>
	            <td>${new Date(refund.orderDate).toLocaleString()}</td>
	            <td>${refund.totalAmount.toLocaleString()}원</td>
	            <td>
	                <span class="badge status-badge status-${refund.orderStatus}">
	                    ${statusText[refund.orderStatus] || refund.orderStatus}
	                </span>
	            </td>
	            <td>
	                <div class="action-buttons">
	                    <button class="btn btn-sm btn-success" 
	                            data-order-id="${refund.orderId}"
	                            data-bs-toggle="modal"
	                            data-bs-target="#refundDetailsModal">
	                        <i class="fas fa-eye"></i> 상세
	                    </button>
	                </div>
	            </td>
	        `;
	        return row;
	    }

	    // 에러 처리 함수
	    function handleError(error) {
	        console.error('Error:', error);
	        const refundTableBody = document.getElementById('refundTableBody');
	        refundTableBody.innerHTML = `
	            <tr>
	                <td colspan="6" class="text-center text-danger">
	                    데이터를 불러오는 중 오류가 발생했습니다.<br>
	                    잠시 후 다시 시도해주세요.
	                </td>
	            </tr>
	        `;
	    }

	    // 초기 테이블 로드
	    applyFilters();
	});
	</script>
<script th:inline="javascript">
	function goAttendance() {
		const form = document.createElement('form')
		const id = /*[[${#authentication.name}]]*/""
		
		let input1 = document.createElement('input')
	    
		input1.type = 'hidden'
	    input1.name = 'id'
	    input1.value = id
		
	    form.appendChild(input1)
		
		form.action = `/sudo/goAttendance`
		form.method = 'get'
		document.body.appendChild(form)
		form.submit()
	}
</script>
</body>
</html>
	