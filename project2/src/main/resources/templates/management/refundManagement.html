<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
	  xmlns:sec="http://www.thymeleaf.org/thymeleaf-extras-springsecurity6">
<head>
	<meta charset="UTF-8">
    <meta name="_csrf" th:content="${_csrf.token}"/>
    <meta name="_csrf_header" th:content="${_csrf.headerName}"/>
	<title>환불 관리 대시보드</title>
	<!-- Bootstrap CSS -->
	<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
	<!-- Font Awesome for Icons -->
	<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
    
    <style>
		.status-badge {
			font-size: 0.8em;
			padding: 0.3em 0.6em;
		}
		.status-REFUND_PENDING { background-color: #ffc107; color: black; }
		.status-REFUND_APPROVED { background-color: #28a745; color: white; }
		.status-REFUND_REJECTED { background-color: #dc3545; color: white; }
        
		.action-buttons {
			display: flex;
			gap: 0.5rem;
		}
		.filter-section {
			background-color: #f8f9fa;
			padding: 1rem;
			margin-bottom: 1rem;
			border-radius: 0.5rem;
		}
	</style>
</head>
<body>
	<div class="container-fluid">
		<div class="row">
			<!-- Sidebar Navigation -->
			<nav class="col-md-2 d-md-block bg-light sidebar">
				<div class="position-sticky">
					<ul class="nav flex-column">
						<li class="nav-item">
							<a class="nav-link" href="/manager/orders">
								<i class="fas fa-shopping-cart"></i> 주문 관리
							</a>
						</li>
						<li class="nav-item">
							<a class="nav-link active" href="#">
								<i class="fas fa-undo"></i> 환불 관리
							</a>
						</li>
						<li class="nav-item">
						<a class="nav-link" href="#">
							<i class="fas fa-chart-bar"></i> 매출 통계
							</a>
						</li>
						<hr class="my-3">
			            <li class="nav-item">
			                <a class="nav-link" href="/shop/list">
			                    <i class="fas fa-shopping-bag"></i> 쇼핑몰 바로가기
			                </a>
			            </li>
					</ul>
				</div>
			</nav>

            <!-- Main Content -->
            <main class="col-md-10 ms-sm-auto px-4">
                <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                    <h1 class="h2">환불 관리 대시보드</h1>
                </div>

                <!-- Filters -->
                <div class="filter-section">
                    <div class="row">
                        <div class="col-md-3">
                            <select class="form-select" id="statusFilter">
                                <option value="">전체 상태</option>
                                <option value="REFUND_PENDING">환불 대기</option>
                                <option value="REFUND_APPROVED">환불 승인</option>
                                <option value="REFUND_REJECTED">환불 거절</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <input type="date" class="form-control" id="startDateFilter">
                        </div>
                        <div class="col-md-3">
                            <input type="date" class="form-control" id="endDateFilter">
                        </div>
                        <div class="col-md-3">
                            <input type="text" class="form-control" placeholder="고객명 검색" id="searchInput">
                        </div>
                    </div>
                </div>

                <!-- Refund List -->
                <div class="table-responsive">
                    <table class="table table-striped table-hover">
                        <thead class="table-dark">
                            <tr>
								<th>주문 번호</th>
								<th>고객명</th>
								<th>주문 날짜</th>
								<th>환불 금액</th>
								<th>상태</th>
								<th>액션</th>
                            </tr>
                        </thead>
                        <tbody id="refundTableBody">
                            <tr th:each="refund : ${refundList.content}">
								<td th:text="${refund.orderId}">주문 번호</td>
								<td th:text="${refund.customerName}">고객명</td>
								<td th:text="${#temporals.format(refund.orderDate, 'yyyy-MM-dd HH:mm')}">주문 날짜</td>
								<td th:text="${#numbers.formatInteger(refund.totalAmount, 0, 'COMMA') + '원'}">환불 금액</td>
								<td>
									<span th:class="|badge status-badge status-${refund.refundStatus}|"
									      th:text="${refund.refundStatus}">상태</span>
                                </td>
                                <td>
                                    <div class="action-buttons">
										<button class="btn btn-sm btn-success"
												th:data-order-id="${refund.orderId}"
												data-bs-toggle="modal"
												data-bs-target="#refundDetailsModal">
											<i class="fas fa-eye"></i> 상세
                                        </button>
                                        <button class="btn btn-sm btn-primary refund-approve-btn"
                                        		th:data-order-id="${refund.orderId}"
                                                th:disabled="${refund.refundStatus != 'REFUND_PENDING'}">
											<i class="fas fa-check"></i> 승인
										</button>
										<button class="btn btn-sm btn-danger refund-reject-btn"
												th:data-order-id="${refund.orderId}"
												th:disabled="${refund.refundStatus != 'REFUND_PENDING'}">
                                            <i class="fas fa-times"></i> 거절
                                        </button>
                                    </div>
                                </td>
                            </tr>
                            <!-- More rows will be dynamically added -->
                        </tbody>
                    </table>
                </div>

                <!-- Pagination -->
                <nav aria-label="Page navigation">
                    <ul class="pagination justify-content-center">
						<li class="page-item" th:classappend="${!refundList.hasPrevious} ? disabled">
							<a class="page-link" th:href="@{/manager/refunds(page=${refundList.number - 1})}">이전</a>
                        </li>
                        <li class="page-item" th:each="pageNum : ${#numbers.sequence(0, refundList.totalPages - 1)}"
                        	th:classappend="${pageNum == refundList.number} ? 'active'">
							<a class="page-link" th:href="@{/manager/refunds(page=${pageNum})}"
								th:text="${pageNum + 1}">1</a>
                        </li>
						<li class="page-item" th:classappend="${!refundList.hasNext} ? disabled">
							<a class="page-link" th:href="@{/manager/refunds(page=${refundList.number + 1})}">다음</a>
						</li>
                    </ul>
                </nav>
            </main>
        </div>
    </div>

    <!-- Refund Details Modal -->
    <div class="modal fade" id="refundDetailsModal" tabindex="-1" aria-labelledby="refundDetailsModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="refundDetailsModalLabel">환불 상세 정보</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h6>주문자 정보</h6>
                            <p><strong>이름:</strong> <span id="customerName"></span></p>
                            <p><strong>연락처:</strong> <span id="customerPhone"></span></p>
                            <p><strong>이메일:</strong> <span id="customerEmail"></span></p>
                        </div>
                        <div class="col-md-6">
                            <h6>환불 정보</h6>
                            <p><strong>환불 사유:</strong> <span id="refundReason"></span></p>
                            <p><strong>환불 방법:</strong> <span id="refundMethod"></span></p>
                            <p><strong>환불 요청 날짜:</strong> <span id="refundRequestDate"></span></p>
                        </div>
                    </div>

                    <h6 class="mt-3">주문 상품 목록</h6>
                    <table class="table">
                        <thead>
                            <tr>
                                <th>상품명</th>
                                <th>수량</th>
                                <th>가격</th>
                                <th>소계</th>
                            </tr>
                        </thead>
						<tbody id="refundProductsBody">
                        </tbody>
                        <tfoot>
                            <tr>
                                <td colspan="3" class="text-end"><strong>총 환불 금액</strong></td>
                                <td><strong id="totalRefundAmount"></strong></td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">닫기</button>
                    <button type="button" class="btn btn-success refund-approve-btn">환불 승인</button>
                    <button type="button" class="btn btn-danger refund-reject-btn">환불 거절</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS and Popper.js -->
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.6/dist/umd/popper.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.min.js"></script>
    
	<script>
	document.addEventListener('DOMContentLoaded', function() {
	    const refundApproveButtons = document.querySelectorAll('.refund-approve-btn');
	    const refundRejectButtons = document.querySelectorAll('.refund-reject-btn');
	
	    function updateRefundStatus(orderId, status) {
	        const token = document.querySelector('meta[name="_csrf"]').getAttribute('content');
	        const header = document.querySelector('meta[name="_csrf_header"]').getAttribute('content');
	        
	        fetch('/api/manager/refunds/' + orderId + '/status', {
	            method: 'PATCH',
	            headers: {
	                'Content-Type': 'application/json',
	                [header]: token
	            },
	            body: JSON.stringify({
	                status: status
	            })
	        })
	        .then(response => response.json())
	        .then(data => {
	            // 화면 업데이트
				const statusBadge = document.querySelector(`button[data-order-id="${orderId}"]`)
					.closest('tr')
					.querySelector('.status-badge');
	            
	            statusBadge.classList.remove('status-REFUND_PENDING', 'status-REFUND_APPROVED', 'status-REFUND_REJECTED');
	            statusBadge.classList.add(`status-${status}`);
	            
	            // 상태 텍스트 업데이트
				const statusText = {
					'REFUND_PENDING': '환불 대기',
					'REFUND_APPROVED': '환불 승인',
					'REFUND_REJECTED': '환불 거절'
				};
				statusBadge.textContent = statusText[status];
				
				// 버튼 비활성화
				const approveBtn = document.querySelector(`button.refund-approve-btn[data-order-id="${orderId}"]`);
				const rejectBtn = document.querySelector(`button.refund-reject-btn[data-order-id="${orderId}"]`);
				if (approveBtn) approveBtn.disabled = true;
				if (rejectBtn) rejectBtn.disabled = true;
				
				alert('환불 상태가 변경되었습니다.');
	        })
	        .catch(error => {
	            console.error('Error:', error);
	            alert('환불 상태 변경 중 오류가 발생했습니다.');
	        });
	    }
	
	    // 리스트의 승인/거절 버튼 이벤트 리스너
	    refundApproveButtons.forEach(btn => {
	        btn.addEventListener('click', function() {
	            const orderId = this.dataset.orderId;
	            updateRefundStatus(orderId, 'REFUND_APPROVED');
	        });
	    });
	
	    refundRejectButtons.forEach(btn => {
	        btn.addEventListener('click', function() {
	            const orderId = this.dataset.orderId;
	            updateRefundStatus(orderId, 'REFUND_REJECTED');
	        });
	    });
	    
		const statusFilter = document.getElementById('statusFilter');
		const startDateFilter = document.getElementById('startDateFilter');
		const endDateFilter = document.getElementById('endDateFilter');
		const searchInput = document.getElementById('searchInput');
		
		function applyFilters() {
			const token = document.querySelector('meta[name="_csrf"]').getAttribute('content');
			const header = document.querySelector('meta[name="_csrf_header"]').getAttribute('content');
			
			const params = new URLSearchParams();
			
			// 상태 필터 파라미터 추가
			if (statusFilter.value) {
				params.append('status', statusFilter.value);
			}
			
			// 시작 날짜 필터 파라미터 추가 (시작 시간을 00:00:00으로 설정)
			if (startDateFilter.value) {
				params.append('startDate', startDateFilter.value + 'T00:00:00');
			}
			
			// 종료 날짜 필터 파라미터 추가 (종료 시간을 23:59:59로 설정)
			if (endDateFilter.value) {
				params.append('endDate', endDateFilter.value + 'T23:59:59');
			}
			
			// 검색어 필터 파라미터 추가
			if (searchInput.value.trim()) {
				params.append('search', searchInput.value.trim());
			}
			
		    // 페이징 파라미터 추가 (첫 페이지부터 시작, 페이지당 10개 항목)
		    params.append('page', '0');
		    params.append('size', '10');
			
		    // 환불 데이터 조회 API 호출
		    fetch(`/api/manager/refunds/management?${params.toString()}`, {
				method: 'GET',
				headers: {
					[header]: token
				}
			})
			.then(response => response.json())
			.then(data => {
				const refundTableBody = document.getElementById('refundTableBody');
				refundTableBody.innerHTML = ''; // 테이블 초기화
				
		        // 검색 결과가 없는 경우 처리
		         if (!data || !data.content || data.content.length === 0) {
		            refundTableBody.innerHTML = `
		                <tr>
		                    <td colspan="6" class="text-center">검색 결과가 없습니다.</td>
		                </tr>
		            `;
		            return;
		        }
				
				// 데이터 동적으로 테이블에 추가
				data.content.forEach(refund => {
					const row = document.createElement('tr');
					row.innerHTML = `
	                    <td>${refund.orderId}</td>
	                    <td>${refund.customerName}</td>
	                    <td>${new Date(refund.orderDate).toLocaleString()}</td>
	                    <td>${refund.totalAmount.toLocaleString()}원</td>
	                    <td>
	                        <span class="badge status-badge status-${refund.refundStatus}">
	                            ${getRefundStatusText(refund.refundStatus)}
	                        </span>
	                    </td>
	                    <td>
	                        <div class="action-buttons">
	                            <button class="btn btn-sm btn-success" 
	                                    data-order-id="${refund.orderId}"
	                                    data-bs-toggle="modal"
	                                    data-bs-target="#refundDetailsModal">
	                                <i class="fas fa-eye"></i> 상세
	                            </button>
	                            <button class="btn btn-sm btn-primary refund-approve-btn"
	                                    data-order-id="${refund.orderId}"
	                                    ${refund.refundStatus !== 'REFUND_PENDING' ? 'disabled' : ''}>
	                                <i class="fas fa-check"></i> 승인
	                            </button>
	                            <button class="btn btn-sm btn-danger refund-reject-btn"
	                                    data-order-id="${refund.orderId}"
	                                    ${refund.refundStatus !== 'REFUND_PENDING' ? 'disabled' : ''}>
	                                <i class="fas fa-times"></i> 거절
	                            </button>
	                        </div>
	                    </td>
	                `;
					refundTableBody.appendChild(row);
				});
				
				// 이벤트 리스너 재설정
				attachEventListeners();
			})
			.catch(error => {
			    console.error('필터링 중 오류:', error);
			    const refundTableBody = document.getElementById('refundTableBody');
			    refundTableBody.innerHTML = `
			        <tr>
			            <td colspan="6" class="text-center text-danger">
			                데이터를 불러오는 중 오류가 발생했습니다.<br>
			                잠시 후 다시 시도해주세요.
			            </td>
			        </tr>
			    `;
			})
		}
		
		// 환불 상태 텍스트 변환 함수
		function getRefundStatusText(status) {
			const statusTexts = {
				'REFUND_PENDING': '환불 대기',
				'REFUND_APPROVED': '환불 승인',
				'REFUND_REJECTED': '환불 거절'
			};
			return statusTexts[status] || status;
		}
		
	    // 이벤트 리스너 등록 함수
	    function attachEventListeners() {
	        const refundApproveButtons = document.querySelectorAll('.refund-approve-btn');
	        const refundRejectButtons = document.querySelectorAll('.refund-reject-btn');
	        const detailButtons = document.querySelectorAll('[data-bs-target="#refundDetailsModal"]');

	        // 승인/거절 버튼 이벤트 리스너
	        refundApproveButtons.forEach(btn => {
	            btn.addEventListener('click', function() {
	                const orderId = this.dataset.orderId;
	                updateRefundStatus(orderId, 'REFUND_APPROVED');
	            });
	        });

	        refundRejectButtons.forEach(btn => {
	            btn.addEventListener('click', function() {
	                const orderId = this.dataset.orderId;
	                updateRefundStatus(orderId, 'REFUND_REJECTED');
	            });
	        });

	        // 상세 버튼 이벤트 리스너
	        detailButtons.forEach(btn => {
	            btn.addEventListener('click', function() {
	                const orderId = this.dataset.orderId;
	                loadRefundDetails(orderId);
	            });
	        });
	    }

	    // 환불 상세 정보 로드 함수
	    function loadRefundDetails(orderId) {
	        const refundDetailsModal = document.getElementById('refundDetailsModal');
	        const modalBody = refundDetailsModal.querySelector('.modal-body');
	        
	        // 로딩 스피너 표시
	        modalBody.innerHTML = '<div class="text-center"><div class="spinner-border" role="status"><span class="visually-hidden">로딩중...</span></div></div>';
	        
	        // 환불 상세 정보 조회 API 호출
	        fetch(`/api/manager/refunds/${orderId}`)
	            .then(response => {
	                if (!response.ok) {
	                    throw new Error(`HTTP 오류! 상태: ${response.status}`);
	                }
	                return response.json();
	            })
	            .then(refundDetails => {
	                if (!refundDetails) {
	                    throw new Error('서버에서 데이터를 받지 못했습니다.');
	                }
	                
	                // 모달 내용 업데이트
	                modalBody.innerHTML = `
	                    <div class="row">
	                        <div class="col-md-6">
	                            <h6>주문자 정보</h6>
	                            <p><strong>고객명:</strong> <span id="customerName">${refundDetails.customerName || '정보 없음'}</span></p>
	                            <p><strong>연락처:</strong> <span id="customerPhone">${refundDetails.phoneNumber || '정보 없음'}</span></p>
	                            <p><strong>이메일:</strong> <span id="customerEmail">${refundDetails.email || '정보 없음'}</span></p>
	                        </div>
	                        <div class="col-md-6">
	                            <h6>환불 정보</h6>
	                            <p><strong>환불 사유:</strong> <span id="refundReason">${refundDetails.refundReason || '사유 없음'}</span></p>
	                            <p><strong>환불 방법:</strong> <span id="refundMethod">${refundDetails.refundMethod || '정보 없음'}</span></p>
	                            <p><strong>환불 요청 날짜:</strong> <span id="refundRequestDate">${new Date(refundDetails.refundRequestDate).toLocaleString()}</span></p>
	                        </div>
	                    </div>

	                    <h6 class="mt-3">주문 상품 목록</h6>
	                    <table class="table">
	                        <thead>
	                            <tr>
	                                <th>상품명</th>
	                                <th>수량</th>
	                                <th>가격</th>
	                                <th>소계</th>
	                            </tr>
	                        </thead>
	                        <tbody id="refundProductsBody"></tbody>
	                        <tfoot>
	                            <tr>
	                                <td colspan="3" class="text-end"><strong>총 환불 금액</strong></td>
	                                <td><strong id="totalRefundAmount"></strong></td>
	                            </tr>
	                        </tfoot>
	                    </table>
	                `;
	                
	                // 상품 목록 업데이트
	                const productTableBody = document.getElementById('refundProductsBody');
	                let totalAmount = 0;
	                
	                if (refundDetails.products && Array.isArray(refundDetails.products)) {
	                    refundDetails.products.forEach(product => {
	                        const row = document.createElement('tr');
	                        row.innerHTML = `
	                            <td>${product.productName || '상품명 없음'}</td>
	                            <td>${product.quantity || 0}</td>
	                            <td>${(product.price || 0).toLocaleString()}원</td>
	                            <td>${(product.totalPrice || 0).toLocaleString()}원</td>
	                        `;
	                        productTableBody.appendChild(row);
	                        totalAmount += product.totalPrice || 0;
	                    });
	                } else {
	                    productTableBody.innerHTML = '<tr><td colspan="4" class="text-center">상품 정보가 없습니다.</td></tr>';
	                }
	                
	                // 총 환불 금액 업데이트
	                document.getElementById('totalRefundAmount').textContent = 
	                    totalAmount.toLocaleString() + '원';
	                
	                // 모달 버튼 업데이트
	                const approveBtn = refundDetailsModal.querySelector('.refund-approve-btn');
	                const rejectBtn = refundDetailsModal.querySelector('.refund-reject-btn');
	                if (approveBtn && rejectBtn) {
	                    approveBtn.dataset.orderId = orderId;
	                    rejectBtn.dataset.orderId = orderId;
	                    
	                    // 상태에 따라 버튼 비활성화
	                    const isDisabled = refundDetails.refundStatus !== 'REFUND_PENDING';
	                    approveBtn.disabled = isDisabled;
	                    rejectBtn.disabled = isDisabled;
	                }
	            })
	            .catch(error => {
	                console.error('환불 상세 정보 조회 중 오류: ', error);
	                modalBody.innerHTML = `
	                    <div class="alert alert-danger" role="alert">
	                        환불 정보를 불러오는 중 오류가 발생했습니다.<br>
	                        새로고침 후 다시 시도해주세요.
	                    </div>
	                `;
	            });
	    }

	    // 필터 변경 이벤트 리스너
	    statusFilter.addEventListener('change', applyFilters);
	    startDateFilter.addEventListener('change', applyFilters);
	    endDateFilter.addEventListener('change', applyFilters);
	    
	    // 검색어 입력 디바운싱
	    let searchTimeout;
	    searchInput.addEventListener('input', function() {
	        clearTimeout(searchTimeout);
	        searchTimeout = setTimeout(applyFilters, 300); // 300ms 후에 검색 실행
	    });

	    // 모달 내 승인/거절 버튼 이벤트 리스너
	    const modalApproveBtn = document.querySelector('#refundDetailsModal .refund-approve-btn');
	    const modalRejectBtn = document.querySelector('#refundDetailsModal .refund-reject-btn');

	    [modalApproveBtn, modalRejectBtn].forEach(btn => {
	        btn.addEventListener('click', function() {
	            const orderId = this.dataset.orderId;
	            const status = this.classList.contains('btn-success') ? 'REFUND_APPROVED' : 'REFUND_REJECTED';

	            updateRefundStatus(orderId, status);
	            
	            // 모달 닫기
	            bootstrap.Modal.getInstance(document.getElementById('refundDetailsModal')).hide();
	        });
	    });

	    // 초기 페이지 로드 시 이벤트 리스너 설정
	    attachEventListeners();
	});
	</script>
</body>
</html>
	